!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("exifr",["exports"],e):e((t=t||self).exifr={})}(this,(function(t){"use strict";function e(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}let i="undefined"!=typeof self?self:global;var s="undefined"!=typeof navigator,n=s&&"undefined"==typeof HTMLImageElement,r=!("undefined"==typeof global||"undefined"==typeof process||!process.versions||!process.versions.node);let a=i.Buffer,h=i.BigInt;var f=!!a;const o=t=>void 0!==t;function l(t){return void 0===t||(t instanceof Map?0===t.size:0===Object.values(t).filter(o).length)}function u(t){let e=new Error(t);return delete e.stack,e}function d(t){let e=function(t){let e=0;return t.ifd0.enabled&&(e+=1024),t.exif.enabled&&(e+=2048),t.makerNote&&(e+=2048),t.userComment&&(e+=1024),t.gps.enabled&&(e+=512),t.interop.enabled&&(e+=100),t.ifd1.enabled&&(e+=1024),e+2048}(t);return t.jfif.enabled&&(e+=50),t.xmp.enabled&&(e+=2e4),t.iptc.enabled&&(e+=14e3),t.icc.enabled&&(e+=6e3),e}const c="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):void 0;class p{static from(t,e){return t instanceof this&&t.le===e?t:new p(t,void 0,void 0,e)}constructor(t,e=0,i,s){if("boolean"==typeof s&&(this.le=s),Array.isArray(t)&&(t=new Uint8Array(t)),0===t)this.byteOffset=0,this.byteLength=0;else if(t instanceof ArrayBuffer){void 0===i&&(i=t.byteLength-e);let s=new DataView(t,e,i);this._swapDataView(s)}else if(t instanceof Uint8Array||t instanceof DataView||t instanceof p){if(void 0===i&&(i=t.byteLength-e),(e+=t.byteOffset)+i>t.byteOffset+t.byteLength)throw u("Creating view outside of available memory in ArrayBuffer");let s=new DataView(t.buffer,e,i);this._swapDataView(s)}else{if("number"!=typeof t)throw u("Invalid input argument for BufferView: "+t);{let e=new DataView(new ArrayBuffer(t));this._swapDataView(e)}}}_swapArrayBuffer(t){this._swapDataView(new DataView(t))}_swapBuffer(t){this._swapDataView(new DataView(t.buffer,t.byteOffset,t.byteLength))}_swapDataView(t){this.dataView=t,this.buffer=t.buffer,this.byteOffset=t.byteOffset,this.byteLength=t.byteLength}_lengthToEnd(t){return this.byteLength-t}set(t,e,i=p){if(t instanceof DataView||t instanceof p?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof ArrayBuffer&&(t=new Uint8Array(t)),!(t instanceof Uint8Array))throw u("BufferView.set(): Invalid data argument.");return this.toUint8().set(t,e),new i(this,e,t.byteLength)}subarray(t,e){return e=e||this._lengthToEnd(t),new p(this,t,e)}toUint8(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}getUint8Array(t,e){return new Uint8Array(this.buffer,this.byteOffset+t,e)}getString(t=0,e=this.byteLength){let i=this.getUint8Array(t,e);return s=i,c?c.decode(s):f?Buffer.from(s).toString("utf8"):decodeURIComponent(escape(String.fromCharCode.apply(null,s)));var s}getUnicodeString(t=0,e=this.byteLength){const i=[];for(let s=0;s<e&&t+s<this.byteLength;s+=2)i.push(this.getUint16(t+s));return i.map(t=>String.fromCharCode(t)).join("")}getInt8(t){return this.dataView.getInt8(t)}getUint8(t){return this.dataView.getUint8(t)}getInt16(t,e=this.le){return this.dataView.getInt16(t,e)}getInt32(t,e=this.le){return this.dataView.getInt32(t,e)}getUint16(t,e=this.le){return this.dataView.getUint16(t,e)}getUint32(t,e=this.le){return this.dataView.getUint32(t,e)}getFloat32(t,e=this.le){return this.dataView.getFloat32(t,e)}getFloat64(t,e=this.le){return this.dataView.getFloat64(t,e)}getFloat(t,e=this.le){return this.dataView.getFloat32(t,e)}getDouble(t,e=this.le){return this.dataView.getFloat64(t,e)}getUint64(t){let e=this.getUint32(t),i=this.getUint32(t+4);if(e<1048575)return e<<32|i;if(void 0!==typeof h)return console.warn("Using BigInt because of type 64uint but JS can only handle 53b numbers."),h(e)<<h(32)|h(i);throw u("Trying to read 64b value but JS can only handle 53b numbers.")}getUintBytes(t,e,i){switch(e){case 1:return this.getUint8(t,i);case 2:return this.getUint16(t,i);case 4:return this.getUint32(t,i);case 8:return this.getUint64(t,i)}}getUint(t,e,i){switch(e){case 8:return this.getUint8(t,i);case 16:return this.getUint16(t,i);case 32:return this.getUint32(t,i);case 64:return this.getUint64(t,i)}}toString(t){return this.dataView.toString(t,this.constructor.name)}ensureChunk(){}}function g(t,e){throw u("".concat(t," '").concat(e,"' was not loaded, try using full build of exifr."))}class y extends Map{constructor(t){super(),this.kind=t}get(t,e){return this.has(t)||g(this.kind,t),e&&(t in e||function(t,e){throw u("Unknown ".concat(t," '").concat(e,"'."))}(this.kind,t),e[t].enabled||g(this.kind,t)),super.get(t)}keyList(){return Array.from(this.keys())}}var m=new y("file parser"),b=new y("segment parser"),k=new y("file reader");function w(t,e){if((i=t).startsWith("data:")||i.length>1e4)return v(t,e,"base64");if(s)return O(t,e,"url",S);if(r)return v(t,e,"fs");throw u("Invalid input argument");var i}async function O(t,e,i,s){if(k.has(i))return v(t,e,i);if(s)return async function(t,e){let i=await e(t);return new p(i)}(t,s);throw u("Parser ".concat(i," is not loaded"))}async function v(t,e,i){let s=new(k.get(i))(t,e);return await s.read(),s}async function S(t){return fetch(t).then(t=>t.arrayBuffer())}async function U(t){return new Promise((e,i)=>{let s=new FileReader;s.onloadend=()=>e(s.result||new ArrayBuffer),s.onerror=i,s.readAsArrayBuffer(t)})}class A extends Map{get tagKeys(){return this.allKeys||(this.allKeys=Array.from(this.keys())),this.allKeys}get tagValues(){return this.allValues||(this.allValues=Array.from(this.values())),this.allValues}}function x(t,e,i){let s=new A;for(let[t,e]of i)s.set(t,e);if(Array.isArray(e))for(let i of e)t.set(i,s);else t.set(e,s);return s}function B(t,e,i){let s,n=t.get(e);for(s of i)n.set(s[0],s[1])}const C=new Map,V=new Map,I=new Map,T=["chunked","firstChunkSize","firstChunkSizeNode","firstChunkSizeBrowser","chunkSize","chunkLimit"],L=["jfif","xmp","icc","iptc"],z=["tiff",...L],F=["ifd0","ifd1","exif","gps","interop"],P=[...z,...F],j=["makerNote","userComment"],D=["translateKeys","translateValues","reviveValues","multiSegment"],E=[...D,"sanitize","mergeOutput"];class _{get translate(){return this.translateKeys||this.translateValues||this.reviveValues}}class M extends _{get needed(){return this.enabled||this.deps.size>0}constructor(t,i,s,n){if(super(),e(this,"enabled",!1),e(this,"skip",new Set),e(this,"pick",new Set),e(this,"deps",new Set),e(this,"translateKeys",!1),e(this,"translateValues",!1),e(this,"reviveValues",!1),this.key=t,this.enabled=i,this.parse=this.enabled,this.applyInheritables(n),this.canBeFiltered=F.includes(t),this.canBeFiltered&&(this.dict=C.get(t)),void 0!==s)if(Array.isArray(s))this.parse=this.enabled=!0,this.canBeFiltered&&s.length>0&&this.translateTagSet(s,this.pick);else if("object"==typeof s){if(this.enabled=!0,this.parse=!1!==s.parse,this.canBeFiltered){let{pick:t,skip:e}=s;t&&t.length>0&&this.translateTagSet(t,this.pick),e&&e.length>0&&this.translateTagSet(e,this.skip)}this.applyInheritables(s)}else{if(!0!==s&&!1!==s)throw u("Invalid options argument: ".concat(s));this.parse=this.enabled=s}}applyInheritables(t){let e,i;for(e of D)i=t[e],void 0!==i&&(this[e]=i)}translateTagSet(t,e){if(this.dict){let i,s,{tagKeys:n,tagValues:r}=this.dict;for(i of t)"string"==typeof i?(s=r.indexOf(i),-1===s&&(s=n.indexOf(Number(i))),-1!==s&&e.add(Number(n[s]))):e.add(i)}else for(let i of t)e.add(i)}finalizeFilters(){!this.enabled&&this.deps.size>0?(this.enabled=!0,G(this.pick,this.deps)):this.enabled&&this.pick.size>0&&G(this.pick,this.deps)}}var N={jfif:!1,tiff:!0,xmp:!1,icc:!1,iptc:!1,ifd0:!0,ifd1:!1,exif:!0,gps:!0,interop:!1,makerNote:!1,userComment:!1,multiSegment:!1,skip:[],pick:[],translateKeys:!0,translateValues:!0,reviveValues:!0,sanitize:!0,mergeOutput:!0,silentErrors:!0,chunked:!0,firstChunkSize:void 0,firstChunkSizeNode:512,firstChunkSizeBrowser:65536,chunkSize:65536,chunkLimit:5},R=new Map;class K extends _{static useCached(t){let e=R.get(t);return void 0!==e?e:(e=new this(t),R.set(t,e),e)}constructor(t){if(super(),!0===t)this.setupFromTrue();else if(void 0===t)this.setupFromUndefined();else if(Array.isArray(t))this.setupFromArray(t);else{if("object"!=typeof t)throw u("Invalid options argument ".concat(t));this.setupFromObject(t)}void 0===this.firstChunkSize&&(this.firstChunkSize=s?this.firstChunkSizeBrowser:this.firstChunkSizeNode),this.mergeOutput&&(this.ifd1.enabled=!1),this.filterNestedSegmentTags(),this.traverseTiffDependencyTree(),this.checkLoadedPlugins()}setupFromUndefined(){let t;for(t of T)this[t]=N[t];for(t of E)this[t]=N[t];for(t of j)this[t]=N[t];for(t of P)this[t]=new M(t,N[t],void 0,this)}setupFromTrue(){let t;for(t of T)this[t]=N[t];for(t of E)this[t]=N[t];for(t of j)this[t]=!0;for(t of P)this[t]=new M(t,!0,void 0,this)}setupFromArray(t){let e;for(e of T)this[e]=N[e];for(e of E)this[e]=N[e];for(e of j)this[e]=N[e];for(e of P)this[e]=new M(e,!1,void 0,this);this.setupGlobalFilters(t,void 0,F)}setupFromObject(t){let e;for(e of(F.ifd0=F.ifd0||F.image,F.ifd1=F.ifd1||F.thumbnail,Object.assign(this,t),T))this[e]=H(t[e],N[e]);for(e of E)this[e]=H(t[e],N[e]);for(e of j)this[e]=H(t[e],N[e]);for(e of z)this[e]=new M(e,N[e],t[e],this);for(e of F)this[e]=new M(e,N[e],t[e],this.tiff);this.setupGlobalFilters(t.pick,t.skip,F,P),!0===t.tiff?this.batchEnableWithBool(F,!0):!1===t.tiff?this.batchEnableWithUserValue(F,t):Array.isArray(t.tiff)?this.setupGlobalFilters(t.tiff,void 0,F):"object"==typeof t.tiff&&this.setupGlobalFilters(t.tiff.pick,t.tiff.skip,F)}batchEnableWithBool(t,e){for(let i of t)this[i].enabled=e}batchEnableWithUserValue(t,e){for(let i of t){let t=e[i];this[i].enabled=!1!==t&&void 0!==t}}setupGlobalFilters(t,e,i,s=i){if(t&&t.length){for(let t of s)this[t].enabled=!1;let e=W(t,i);for(let[t,i]of e)G(this[t].pick,i),this[t].enabled=!0}else if(e&&e.length){let t=W(e,i);for(let[e,i]of t)G(this[e].skip,i)}}filterNestedSegmentTags(){let{ifd0:t,exif:e,xmp:i,iptc:s,icc:n}=this;this.makerNote?e.deps.add(37500):e.skip.add(37500),this.userComment?e.deps.add(37510):e.skip.add(37510),i.enabled||t.skip.add(700),s.enabled||t.skip.add(33723),n.enabled||t.skip.add(34675)}traverseTiffDependencyTree(){let{ifd0:t,exif:e,gps:i,interop:s}=this;s.needed&&(e.deps.add(40965),t.deps.add(40965)),e.needed&&t.deps.add(34665),i.needed&&t.deps.add(34853),this.tiff.enabled=F.some(t=>!0===this[t].enabled)||this.makerNote||this.userComment;for(let t of F)this[t].finalizeFilters()}get onlyTiff(){return!L.map(t=>this[t].enabled).some(t=>!0===t)&&this.tiff.enabled}checkLoadedPlugins(){for(let t of z)this[t].enabled&&!b.has(t)&&g("segment parser",t)}}function W(t,e){let i,s,n,r,a=[];for(n of e){for(r of(i=C.get(n),s=[],i))(t.includes(r[0])||t.includes(r[1]))&&s.push(r[0]);s.length&&a.push([n,s])}return a}function H(t,e){return void 0!==t?t:void 0!==e?e:void 0}function G(t,e){for(let i of e)t.add(i)}e(K,"default",N);const J={ifd0:!1,ifd1:!1,exif:!1,gps:!1,interop:!1,sanitize:!1,reviveValues:!0,translateKeys:!1,translateValues:!1,mergeOutput:!1},X=Object.assign({},J,{firstChunkSize:4e4,gps:[1,2,3,4]}),q=Object.assign({},J,{firstChunkSize:4e4,ifd0:[274]}),Q=Object.assign({},J,{tiff:!1,ifd1:!0,mergeOutput:!1});class Y{constructor(t){e(this,"parsers",{}),this.options=K.useCached(t)}setup(){if(this.fileParser)return;let t,e=this.file.getUint16(0);if(18761===e||19789===e)this.file.isTiff=!0,t=m.get("tiff");else if(65496===e)this.file.isJpeg=!0,t=m.get("jpeg");else{if(!function(t){if(0!==t.getUint16(0))return!1;let e=t.getUint16(2);if(e>50)return!1;let i=16,s=[];for(;i<e;)s.push(t.getString(i,4)),i+=4;return s.includes("heic")}(this.file))throw u("Unknown file format");this.file.isHeic=!0,t=m.get("heic")}this.fileParser=new t(this.options,this.file,this.parsers)}async read(t){this.file=await function(t,e){if("string"==typeof t)return w(t,e);if(s&&!n&&t instanceof HTMLImageElement)return w(t.src,e);if(t instanceof Uint8Array||t instanceof ArrayBuffer||t instanceof DataView)return new p(t);if(s&&t instanceof Blob)return O(t,e,"blob",U);throw u("Invalid input argument")}(t,this.options)}async parse(){this.setup(),await this.fileParser.parse();let t={},e=[],i=Object.values(this.parsers).map(async i=>{let s;if(this.options.silentErrors){try{s=await i.parse()}catch(t){e.push(t)}i.errors.length&&e.push(...i.errors)}else s=await i.parse();i.assignToOutput(t,s)});var s;return await Promise.all(i),this.options.silentErrors&&e.length>0&&(t.errors=e),t=l(s=t)?void 0:s,this.file.close&&this.file.close(),t}async extractThumbnail(){this.setup();let t=b.get("tiff",this.options);var e;if(this.file.isTiff?e={start:0,type:"tiff"}:this.file.isJpeg&&(e=await this.fileParser.getOrFindSegment("tiff")),void 0===e)return;let i=await this.fileParser.ensureSegmentChunk(e),s=this.parsers.tiff=new t(i,this.options,this.file),n=await s.extractThumbnail();return this.file.close&&this.file.close(),n}}async function Z(t,e){let i=new Y(e);return await i.read(t),i.parse()}async function $(t){let e=new Y(Q);await e.read(t);let i=await e.extractThumbnail();return i&&f?a.from(i):i}async function tt(t){let e=await this.thumbnail(t);if(void 0!==e){let t=new Blob([e]);return URL.createObjectURL(t)}}async function et(t){let e=new Y(X);await e.read(t);let i=await e.parse();if(i&&i.gps){let{latitude:t,longitude:e}=i.gps;return{latitude:t,longitude:e}}}async function it(t){let e=new Y(q);await e.read(t);let i=await e.parse();if(i&&i.ifd0)return i.ifd0[274]}var st=Object.freeze({__proto__:null,parse:Z,thumbnail:$,thumbnailUrl:tt,gps:et,orientation:it,Exifr:Y,fileParsers:m,segmentParsers:b,fileReaders:k,tagKeys:C,tagValues:V,tagRevivers:I,createDictionary:x,extendDictionary:B,fetchUrlAsArrayBuffer:S,readBlobAsArrayBuffer:U,chunkedProps:T,otherSegments:L,segments:z,tiffBlocks:F,segmentsAndBlocks:P,tiffExtractables:j,inheritables:D,allFormatters:E,Options:K,disableAllOptions:J,gpsOnlyOptions:X,orientationOnlyOptions:q,thumbnailOnlyOptions:Q});class nt extends p{constructor(...t){super(...t),e(this,"ranges",new rt),0!==this.byteLength&&this.ranges.add(0,this.byteLength)}_tryExtend(t,e,i){if(0===t&&0===this.byteLength&&i){let t=new DataView(i.buffer||i,i.byteOffset,i.byteLength);this._swapDataView(t)}else{let i=t+e;if(i>this.byteLength){let{dataView:t}=this._extend(i);this._swapDataView(t)}}}_extend(t){let e;e=f?a.allocUnsafe(t):new Uint8Array(t);let i=new DataView(e.buffer,e.byteOffset,e.byteLength);return e.set(new Uint8Array(this.buffer,this.byteOffset,this.byteLength),0),{uintView:e,dataView:i}}subarray(t,e,i=!1){return e=e||this._lengthToEnd(t),i&&this._tryExtend(t,e),this.ranges.add(t,e),super.subarray(t,e)}set(t,e,i=!1){i&&this._tryExtend(e,t.byteLength,t);let s=super.set(t,e);return this.ranges.add(e,s.byteLength),s}async ensureChunk(t,e){this.chunked&&(this.ranges.available(t,e)||await this.readChunk(t,e))}available(t,e){return this.ranges.available(t,e)}}class rt{constructor(){e(this,"list",[])}get length(){return this.list.length}add(t,e,i=0){let s=t+e,n=this.list.filter(e=>at(t,e.offset,s)||at(t,e.end,s));if(n.length>0){t=Math.min(t,...n.map(t=>t.offset)),s=Math.max(s,...n.map(t=>t.end)),e=s-t;let i=n.shift();i.offset=t,i.length=e,i.end=s,this.list=this.list.filter(t=>!n.includes(t))}else this.list.push({offset:t,length:e,end:s})}available(t,e){let i=t+e;return this.list.some(e=>e.offset<=t&&i<=e.end)}}function at(t,e,i){return t<=e&&e<=i}class ht extends nt{constructor(t,i){super(0),e(this,"chunksRead",0),this.input=t,this.options=i}async readWhole(){this.chunked=!1,await this.readChunk(this.nextChunkOffset)}async readChunked(){this.chunked=!0,await this.readChunk(0,this.options.firstChunkSize)}async readNextChunk(t=this.nextChunkOffset){if(this.fullyRead)return this.chunksRead++,!1;let e=this.options.chunkSize,i=await this.readChunk(t,e);return!!i&&i.byteLength===e}async readChunk(t,e){if(this.chunksRead++,0!==(e=this.safeWrapAddress(t,e)))return this._readChunk(t,e)}safeWrapAddress(t,e){return void 0!==this.size&&t+e>this.size?Math.max(0,this.size-t):e}get nextChunkOffset(){if(0!==this.ranges.list.length)return this.ranges.list[0].length}get canReadNextChunk(){return this.chunksRead<this.options.chunkLimit}get fullyRead(){return void 0!==this.size&&this.nextChunkOffset===this.size}read(){return this.options.chunked?this.readChunked():this.readWhole()}close(){}}k.set("blob",class extends ht{async readWhole(){this.chunked=!1;let t=await U(this.input);this._swapArrayBuffer(t)}readChunked(){return this.chunked=!0,this.size=this.input.size,super.readChunked()}async _readChunk(t,e){let i=e?t+e:void 0,s=this.input.slice(t,i),n=await U(s);return this.set(n,t,!0)}});class ft{static findPosition(t,e){let i=t.getUint16(e+2)+2,s="function"==typeof this.headerLength?this.headerLength(t,e,i):this.headerLength,n=e+s,r=i-s;return{offset:e,length:i,headerLength:s,start:n,size:r,end:n+r}}static parse(t,e={}){return new this(t,new K({[this.type]:e})).parse()}normalizeInput(t){return t instanceof p?t:new p(t)}constructor(t,i={},s){e(this,"errors",[]),e(this,"raw",new Map),e(this,"handleError",t=>{if(!this.options.silentErrors)throw t;this.errors.push(t.message)}),this.chunk=this.normalizeInput(t),this.file=s,this.type=this.constructor.type,this.globalOptions=this.options=i,this.localOptions=i[this.type],this.canTranslate=this.localOptions&&this.localOptions.translate}translate(){this.canTranslate&&(this.translated=this.translateBlock(this.raw,this.type))}get output(){return this.translated?this.translated:this.raw?Object.fromEntries(this.raw):void 0}translateBlock(t,e){let i=I.get(e),s=V.get(e),n=C.get(e),r=this.options[e],a=r.reviveValues&&!!i,h=r.translateValues&&!!s,f=r.translateKeys&&!!n,o={};for(let[e,r]of t)a&&i.has(e)?r=i.get(e)(r):h&&s.has(e)&&(r=this.translateValue(r,s.get(e))),f&&n.has(e)&&(e=n.get(e)||e),o[e]=r;return o}translateValue(t,e){return e[t]||t}assignToOutput(t,e){this.assignObjectToOutput(t,this.constructor.type,e)}assignObjectToOutput(t,e,i){if(this.globalOptions.mergeOutput)return Object.assign(t,i);t[e]?Object.assign(t[e],i):t[e]=i}}e(ft,"headerLength",4),e(ft,"type",void 0),e(ft,"multiSegment",!1),e(ft,"canHandle",()=>!1);function ot(t){return 192===t||194===t||196===t||219===t||221===t||218===t||254===t}function lt(t){return t>=224&&t<=239}function ut(t,e){for(let[i,s]of b)if(s.canHandle(t,e))return i}m.set("jpeg",class extends class{constructor(t,i,s){e(this,"ensureSegmentChunk",async t=>{let e=t.start,i=t.size||65536;if(this.file.chunked)if(this.file.available(e,i))t.chunk=this.file.subarray(e,i);else try{t.chunk=await this.file.readChunk(e,i)}catch(e){throw u("Couldn't read segment: ".concat(JSON.stringify(t),". ").concat(e.message))}else if(this.file.byteLength>e+i)t.chunk=this.file.subarray(e,i);else{if(void 0!==t.size)throw u("Segment unreachable: "+JSON.stringify(t));t.chunk=this.file.subarray(e)}return t.chunk}),this.extendOptions&&this.extendOptions(t),this.options=t,this.file=i,this.parsers=s}createParser(t,e){let i=new(b.get(t))(e,this.options,this.file);return this.parsers[t]=i}}{constructor(...t){super(...t),e(this,"appSegments",[]),e(this,"jpegSegments",[]),e(this,"unknownSegments",[])}async parse(){await this.findAppSegments(),await this.readSegments(),this.mergeMultiSegments(),this.createParsers()}async readSegments(){let t=this.appSegments.map(this.ensureSegmentChunk);await Promise.all(t)}setupSegmentFinderArgs(t){!0===t?(this.findAll=!0,this.wanted=new Set(b.keyList())):(t=void 0===t?b.keyList().filter(t=>this.options[t].enabled):t.filter(t=>this.options[t].enabled&&b.has(t)),this.findAll=!1,this.remaining=new Set(t),this.wanted=new Set(t)),this.unfinishedMultiSegment=!1}async findAppSegments(t=0,e){this.setupSegmentFinderArgs(e);let{file:i,findAll:s,wanted:n,remaining:r}=this;if(!s&&this.file.chunked&&(s=Array.from(n).some(t=>{let e=b.get(t),i=this.options[t];return e.multiSegment&&i.multiSegment}),s&&await this.file.readWhole()),t=this._findAppSegments(t,i.byteLength,s,n,r),!this.options.onlyTiff&&i.chunked){let e=!1;for(;r.size>0&&!e&&(i.canReadNextChunk||this.unfinishedMultiSegment);){let{nextChunkOffset:s}=i,n=this.appSegments.some(t=>!this.file.available(t.offset||t.start,t.length||t.size));if(e=t>s&&!n?!await i.readNextChunk(t):!await i.readNextChunk(s),void 0===(t=this._findAppSegments(t,i.byteLength)))return}}}_findAppSegments(t,e){let i,s,n,r,a,h,{file:f,findAll:o,wanted:l,remaining:u,options:d}=this;for(;t<e;t++)if(255===f.getUint8(t))if(i=f.getUint8(t+1),lt(i)){if(s=f.getUint16(t+2),n=ut(f,t),n&&l.has(n)&&(r=b.get(n),a=r.findPosition(f,t),h=d[n],a.type=n,this.appSegments.push(a),!o&&(r.multiSegment&&h.multiSegment?(this.unfinishedMultiSegment=a.chunkNumber<a.chunkCount,this.unfinishedMultiSegment||u.delete(n)):u.delete(n),0===u.size)))break;d.recordUnknownSegments&&(a=ft.findPosition(f,t),a.marker=i,this.unknownSegments.push(a)),t+=s+1}else if(ot(i)){if(s=f.getUint16(t+2),218===i&&!1!==d.stopAfterSos)return;d.recordJpegSegments&&this.jpegSegments.push({offset:t,length:s,marker:i}),t+=s+1}return t}mergeMultiSegments(){if(!this.appSegments.some(t=>t.multiSegment))return;let t=function(t,e){let i,s,n,r=new Map;for(let a=0;a<t.length;a++)i=t[a],s=i[e],r.has(s)?n=r.get(s):r.set(s,n=[]),n.push(i);return Array.from(r)}(this.appSegments,"type");this.mergedAppSegments=t.map(([t,e])=>{let i=b.get(t,this.options);if(i.handleMultiSegments){return{type:t,chunk:i.handleMultiSegments(e)}}return e[0]})}async createParsers(){let t=this.mergedAppSegments||this.appSegments;for(let e of t){let{type:t,chunk:i}=e;if(!this.options[t].enabled)continue;let s=this.parsers[t];if(s&&s.append);else if(!s){let e=new(b.get(t,this.options))(i,this.options,this.file);this.parsers[t]=e}}}getSegment(t){return this.appSegments.find(e=>e.type===t)}async getOrFindSegment(t){let e=this.getSegment(t);return void 0===e&&(await this.findAppSegments(0,[t]),e=this.getSegment(t)),e}});const dt=[void 0,1,1,2,4,8,1,1,2,4,8,4,8,4];class ct extends ft{parseHeader(){var t=this.chunk.getUint16();if(18761===t)this.le=!0;else{if(19789!==t)throw u("Invalid EXIF data: expected byte order marker (0x4949 or 0x4D4D).");this.le=!1}if(this.chunk.le=this.le,42!==this.chunk.getUint16(2))throw u("Invalid EXIF data: expected 0x002A.");this.headerParsed=!0}parseTags(t,e,i=new Map){let{pick:s,skip:n}=this.options[e];s=new Set(s);let r=s.size>0,a=0===n.size,h=this.chunk.getUint16(t);t+=2;for(let f=0;f<h;f++){let h=this.chunk.getUint16(t);if(r){if(s.has(h)&&(i.set(h,this.parseTag(t,h,e)),s.delete(h),0===s.size))break}else!a&&n.has(h)||i.set(h,this.parseTag(t,h,e));t+=12}return i}parseTag(t,e,i){let s=this.chunk.getUint16(t+2),n=this.chunk.getUint32(t+4),r=dt[s];if(r*n<=4?t+=8:t=this.chunk.getUint32(t+8),s<1||s>13)throw u("Invalid TIFF value type. block: ".concat(i.toUpperCase(),", tag: ").concat(e.toString(16),", type: ").concat(s,", offset ").concat(t));if(t>this.chunk.byteLength)throw u("Invalid TIFF value offset. block: ".concat(i.toUpperCase(),", tag: ").concat(e.toString(16),", type: ").concat(s,", offset ").concat(t," is outside of chunk size ").concat(this.chunk.byteLength));if(1===s)return this.chunk.getUint8Array(t,n);if(2===s)return""===(a=function(t){for(;t.endsWith("\0");)t=t.slice(0,-1);return t}(a=this.chunk.getString(t,n)).trim())?void 0:a;var a;if(7===s)return this.chunk.getUint8Array(t,n);if(1===n)return this.parseTagValue(s,t);{let e=new(function(t){switch(t){case 1:return Uint8Array;case 3:return Uint16Array;case 4:return Uint32Array;case 5:return Array;case 6:return Int8Array;case 8:return Int16Array;case 9:return Int32Array;case 10:return Array;case 11:return Float32Array;case 12:return Float64Array;default:return Array}}(s))(n),i=r;for(let r=0;r<n;r++)e[r]=this.parseTagValue(s,t),t+=i;return e}}parseTagValue(t,e){switch(t){case 1:return this.chunk.getUint8(e);case 3:return this.chunk.getUint16(e);case 4:return this.chunk.getUint32(e);case 5:return this.chunk.getUint32(e)/this.chunk.getUint32(e+4);case 6:return this.chunk.getInt8(e);case 8:return this.chunk.getInt16(e);case 9:return this.chunk.getInt32(e);case 10:return this.chunk.getInt32(e)/this.chunk.getInt32(e+4);case 11:return this.chunk.getFloat(e);case 12:return this.chunk.getDouble(e);case 13:return this.chunk.getUint32(e);default:throw u("Invalid tiff type ".concat(t))}}}class pt extends ct{static canHandle(t,e){return 225===t.getUint8(e+1)&&1165519206===t.getUint32(e+4)&&0===t.getUint16(e+8)}async parse(){return this.parseHeader(),this.options.ifd0.enabled&&await this.parseIfd0Block(),this.options.exif.enabled&&await this.saveParseBlock("parseExifBlock"),this.options.gps.enabled&&await this.saveParseBlock("parseGpsBlock"),this.options.interop.enabled&&await this.saveParseBlock("parseInteropBlock"),this.options.ifd1.enabled&&await this.saveParseBlock("parseThumbnailBlock"),this.createOutput()}async saveParseBlock(t){try{return await this[t]()}catch(t){this.handleError(t)}}findIfd0Offset(){void 0===this.ifd0Offset&&(this.ifd0Offset=this.chunk.getUint32(4))}findIfd1Offset(){if(void 0===this.ifd1Offset){this.findIfd0Offset();let t=this.chunk.getUint16(this.ifd0Offset),e=this.ifd0Offset+2+12*t;this.ifd1Offset=this.chunk.getUint32(e)}}parseBlock(t,e){let i=new Map;return this[e]=i,this.parseTags(t,e,i),i}async parseIfd0Block(){if(this.ifd0)return;if(this.findIfd0Offset(),this.ifd0Offset<8)throw u("Invalid EXIF data: IFD0 offset should be less than 8");if(!this.file.chunked&&this.ifd0Offset>this.file.byteLength)throw u("IFD0 offset points to outside of file.\nthis.ifd0Offset: ".concat(this.ifd0Offset,", file.byteLength: ").concat(this.file.byteLength));this.file.isTiff&&await this.file.ensureChunk(this.ifd0Offset,d(this.options));let t=this.parseBlock(this.ifd0Offset,"ifd0");return 0!==t.size?(this.exifOffset=t.get(34665),this.interopOffset=t.get(40965),this.gpsOffset=t.get(34853),this.xmp=t.get(700),this.iptc=t.get(33723),this.icc=t.get(34675),this.options.sanitize&&(t.delete(34665),t.delete(40965),t.delete(34853),t.delete(700),t.delete(33723),t.delete(34675)),t):void 0}async ensureBlockChunk(t,e){this.file.isTiff&&await this.file.ensureChunk(t,e),t>this.chunk.byteLength&&(this.chunk=p.from(this.file,this.le))}async parseExifBlock(){if(this.exif)return;if(this.ifd0||await this.parseIfd0Block(),void 0===this.exifOffset)return;this.file.isTiff&&await this.file.ensureChunk(this.exifOffset,d(this.options));let t=this.parseBlock(this.exifOffset,"exif");return this.interopOffset||(this.interopOffset=t.get(40965)),this.makerNote=t.get(37500),this.userComment=t.get(37510),this.options.sanitize&&(t.delete(40965),t.delete(37500),t.delete(37510)),this.unpack(t,41728),this.unpack(t,41729),t}unpack(t,e){let i=t.get(e);i&&1===i.length&&t.set(e,i[0])}async parseGpsBlock(){if(this.gps)return;if(this.ifd0||await this.parseIfd0Block(),void 0===this.gpsOffset)return;let t=this.parseBlock(this.gpsOffset,"gps");return t&&t.has(2)&&t.has(4)&&(t.set("latitude",gt(...t.get(2),t.get(1))),t.set("longitude",gt(...t.get(4),t.get(3)))),t}async parseInteropBlock(){if(!this.interop&&(this.ifd0||await this.parseIfd0Block(),void 0!==this.interopOffset||this.exif||await this.parseExifBlock(),void 0!==this.interopOffset))return this.parseBlock(this.interopOffset,"interop")}async parseThumbnailBlock(t=!1){if(!this.ifd1&&!this.ifd1Parsed&&(!this.options.mergeOutput||t))return this.findIfd1Offset(),this.ifd1Offset>0&&(this.parseBlock(this.ifd1Offset,"ifd1"),this.ifd1Parsed=!0),this.ifd1}async extractThumbnail(){if(this.headerParsed||this.parseHeader(),this.ifd1Parsed||await this.parseThumbnailBlock(!0),void 0===this.ifd1)return;let t=this.ifd1.get(513),e=this.ifd1.get(514);return this.chunk.getUint8Array(t,e)}get image(){return this.ifd0}get thumbnail(){return this.ifd1}createOutput(){let t,e,i,s={};for(e of F)if(t=this[e],!l(t))if(i=this.canTranslate?this.translateBlock(t,e):Object.fromEntries(t),this.options.mergeOutput){if("ifd1"===e)continue;Object.assign(s,i)}else s[e]=i;return this.makerNote&&(s.makerNote=this.makerNote),this.userComment&&(s.userComment=this.userComment),s}assignToOutput(t,e){if(this.globalOptions.mergeOutput)Object.assign(t,e);else for(let[i,s]of Object.entries(e))this.assignObjectToOutput(t,i,s)}}function gt(t,e,i,s){var n=t+e/60+i/3600;return"S"!==s&&"W"!==s||(n*=-1),n}e(pt,"type","tiff"),e(pt,"headerLength",10),b.set("tiff",pt),t.Exifr=Y,t.Options=K,t.allFormatters=E,t.chunkedProps=T,t.createDictionary=x,t.default=st,t.disableAllOptions=J,t.extendDictionary=B,t.fetchUrlAsArrayBuffer=S,t.fileParsers=m,t.fileReaders=k,t.gps=et,t.gpsOnlyOptions=X,t.inheritables=D,t.orientation=it,t.orientationOnlyOptions=q,t.otherSegments=L,t.parse=Z,t.readBlobAsArrayBuffer=U,t.segmentParsers=b,t.segments=z,t.segmentsAndBlocks=P,t.tagKeys=C,t.tagRevivers=I,t.tagValues=V,t.thumbnail=$,t.thumbnailOnlyOptions=Q,t.thumbnailUrl=tt,t.tiffBlocks=F,t.tiffExtractables=j,Object.defineProperty(t,"__esModule",{value:!0})}));
